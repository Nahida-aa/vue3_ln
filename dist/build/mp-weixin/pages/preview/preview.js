"use strict";const e=require("../../common/vendor.js"),a=require("../../utils/system.js"),l=require("../../api/apis.js"),o=require("../../store/user.js"),u=require("../../config/index.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-dateformat")+e.resolveComponent("uni-rate")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-icons/uni-icons.js")+(()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-dateformat/uni-dateformat.js")+(()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-rate/uni-rate.js")+(()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-popup/uni-popup.js"))();const s={__name:"preview",setup(s){const t=o.useUserStore();e.ref(t.score_count);const i=e.index.getStorageSync("storeWallList")||[],n=e.ref([]);n.value=i.map((e=>({...e,pic_url:e.small_url.replace("_small","").replace("small","index")})));const r=e.ref(null),d=e.ref(0),c=e.ref(null),v=e.computed((()=>Number(c.value.score).toFixed(1))),p=e.ref([]);e.onLoad((async e=>{if(r.value=e.id,"share"==e.type){let e=await l.apiWallpaper({id:r.value});n.value=e.data.map((e=>({...e,pic_url:e.small_url.replace("_small","").replace("small","index")})))}d.value=n.value.findIndex((e=>e._id==r.value)),_(p,d,n),c.value=n.value[d.value]}));const m=e=>{d.value=e.detail.current,_(p,d,n),c.value=n.value[d.value]},_=(e,a,l)=>{e.value.push(a.value<=0?l.value.length-1:a.value-1,a.value,a.value>=l.value.length-1?0:a.value+1),e.value=[...new Set(e.value)]},f=e.ref(null),h=()=>{f.value.open()},g=()=>{f.value.close()},x=e.ref(null),w=()=>{c.value.user_score&&(S.value=!0,b.value=c.value.user_score),x.value.open()},y=()=>{x.value.close(),S.value=!1},b=e.ref(0),S=e.ref(!1),j=async()=>{let{class_id:a,_id:o}=c.value,u=await l.apiScore({method:"post",data:{class_id:a,wall_id:o,user_score:b.value}});0==u.errCode&&(S.value=!0,e.index.showToast({title:"评分成功"}),c.value.score=u.data.score,i[d.value].score=u.data.score,t.updateScoreCount(u.data.user__score_count),n.value[d.value].user_score=b.value,e.index.setStorageSync("storeWallList",n.value)),x.value.close()},k=async()=>{try{u.is_dev,e.index.showLoading({title:"下载中...",mask:!0});let{class_id:a,_id:o}=c.value,s=await l.apiDownload({method:"post",data:{class_id:a,wall_id:o}});e.index.getImageInfo({src:c.value.pic_url,success:a=>{u.is_dev,e.index.saveImageToPhotosAlbum({filePath:a.path,success:e=>{u.is_dev,t.updateDownloadCount(s.data.user__download_count)},fail:a=>{u.is_dev,"saveImageToPhotosAlbum:fail cancel"!=a.errMsg?e.index.showModal({title:"提示",content:"需要授权保存到相册",success:a=>{a.confirm&&e.index.openSetting({success:a=>{u.is_dev,a.authSetting["scope.writePhotosAlbum"]?e.index.showToast({title:"授权成功",icon:"success"}):e.index.showToast({title:"授权失败",icon:"none"})}})}}):e.index.showToast({title:"取消保存",icon:"none"})},complete:a=>{e.index.hideLoading()}})}})}catch(a){e.index.hideLoading()}},C=e.ref(!0),I=()=>{C.value=!C.value},L=()=>{e.index.navigateBack({success:e=>{},fail:a=>{e.index.reLaunch({url:"/pages/index/index"})}})};return e.onShareAppMessage((e=>({title:"小草壁纸",path:"/pages/preview/preview?id="+r.value+"&type=share"}))),e.onMounted((()=>{const a=e.getCurrentInstance();a&&(a.proxy.onShareTimeline=()=>({title:"小草壁纸~~~",query:"id="+r.value+"&type=share"}))})),(l,o)=>e.e({a:c.value},c.value?{b:e.f(n.value,((a,l,o)=>e.e({a:p.value.includes(l)},p.value.includes(l)?{b:e.o(I,a._id),c:a.pic_url}:{},{d:a._id}))),c:d.value,d:e.o(m),e:e.p({type:"back",color:"#fff",size:"20"}),f:e.o(L),g:e.unref(a.getStatusBarHeight)()+"px",h:e.t(d.value+1),i:e.t(n.value.length),j:e.p({date:new Date,format:"hh:mm"}),k:e.p({date:new Date,format:"MM月dd日"}),l:e.p({type:"info",color:"",size:"28"}),m:e.o(h),n:e.p({type:"star",color:"",size:"28"}),o:e.t(e.unref(v)),p:e.o(w),q:e.o(k),r:e.p({type:"download",color:"",size:"28"}),s:C.value,t:e.p({type:"closeempty",color:"#999",size:"18"}),v:e.o(g),w:e.t(c.value._id),x:e.t(c.value.nickname),y:e.p({readonly:!0,touchable:!1,value:c.value.score}),z:e.t(e.unref(v)),A:e.t(c.value.description),B:e.f(c.value.tags,((a,l,o)=>({a:e.t(a),b:a}))),C:e.sr(f,"e593a063-6",{k:"infoPopup"}),D:e.p({type:"bottom","safe-area":!1}),E:e.t(S.value?"评分过了~":"壁纸评分"),F:e.p({type:"closeempty",color:"#999",size:"18"}),G:e.o(y),H:e.o((e=>b.value=e)),I:e.p({allowHalf:!0,readonly:S.value,modelValue:b.value}),J:e.t(b.value),K:e.o(j),L:!b.value||S.value,M:e.sr(x,"e593a063-9",{k:"scorePopup"}),N:e.p({"is-mask-click":!1})}:{})}},t=e._export_sfc(s,[["__scopeId","data-v-e593a063"]]);s.__runtimeHooks=6,wx.createPage(t);
